-- Migration: 20260214_gamification_suite
-- Purpose: Implement Full Gamification Suite (Operations & Achievements)
-- Theme: Military/Tactical

-- Part A: Profile Updates
-- Add 'goal' and 'rerolls_available' to profiles
ALTER TABLE public.profiles
ADD COLUMN IF NOT EXISTS goal TEXT DEFAULT 'Muscle',
ADD COLUMN IF NOT EXISTS rerolls_available INT DEFAULT 1;

COMMENT ON COLUMN public.profiles.goal IS 'User fitness goal (e.g. Muscle, Strength, Endurance, Weight Loss)';
COMMENT ON COLUMN public.profiles.rerolls_available IS 'Number of times user can reroll daily operations';

-- Part B: Operations System (Daily/Weekly)
-- DROP TABLES IF EXIST to prevent conflicts with old schemas or constraints
DROP TABLE IF EXISTS public.user_operations;
DROP TABLE IF EXISTS public.operations_templates;

-- 1. Create operations_templates table
CREATE TABLE public.operations_templates (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    title TEXT NOT NULL,
    description TEXT,
    type TEXT NOT NULL CHECK (type IN ('daily', 'weekly')),
    target_metric TEXT NOT NULL, -- e.g., 'volume', 'workouts', 'distance'
    target_value INT NOT NULL,
    xp_reward INT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT now()
);

-- 2. Create user_operations table
CREATE TABLE public.user_operations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
    template_id UUID NOT NULL REFERENCES public.operations_templates(id),
    current_progress INT DEFAULT 0,
    is_completed BOOLEAN DEFAULT FALSE,
    expires_at TIMESTAMPTZ NOT NULL,
    created_at TIMESTAMPTZ DEFAULT now(),
    UNIQUE(user_id, template_id, expires_at) -- Prevent duplicate assignments
);

-- Enable RLS for Operations
ALTER TABLE public.operations_templates ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_operations ENABLE ROW LEVEL SECURITY;

-- Policies for Operations
CREATE POLICY "Public read operations_templates" 
ON public.operations_templates FOR SELECT USING (true);

CREATE POLICY "Users can view own operations" 
ON public.user_operations FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can update own operations" 
ON public.user_operations FOR UPDATE USING (auth.uid() = user_id);

-- Part C: Achievements System (Lifetime Badges)
DROP TABLE IF EXISTS public.user_achievements;
DROP TABLE IF EXISTS public.achievements;

-- 1. Create achievements table
CREATE TABLE public.achievements (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name TEXT NOT NULL,
    description TEXT NOT NULL,
    criteria JSONB NOT NULL, -- Stores logic: { "type": "total_workouts", "value": 1 }
    xp_reward INT NOT NULL,
    icon_key TEXT NOT NULL, -- Reference to local asset or icon name
    is_hidden BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMPTZ DEFAULT now()
);

-- 2. Create user_achievements table
CREATE TABLE public.user_achievements (
    user_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
    achievement_id UUID NOT NULL REFERENCES public.achievements(id) ON DELETE CASCADE,
    unlocked_at TIMESTAMPTZ DEFAULT now(),
    PRIMARY KEY (user_id, achievement_id)
);

-- Enable RLS for Achievements
ALTER TABLE public.achievements ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.user_achievements ENABLE ROW LEVEL SECURITY;

-- Policies for Achievements
CREATE POLICY "Public read achievements" 
ON public.achievements FOR SELECT USING (true);

CREATE POLICY "Users can view own achievements" 
ON public.user_achievements FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Service role can manage user achievements" 
ON public.user_achievements FOR ALL USING (true); -- Usually unlocked via backend logic, allowing broad access for now (or refine to service role)

-- Part D: Seed Data (Medical/Tactical Theme)

-- Seed Operations
INSERT INTO public.operations_templates (title, description, type, target_metric, target_value, xp_reward)
VALUES
    ('Morning Drill', 'Complete a workout session before 0900 hours.', 'daily', 'time_of_day_before_9', 1, 150),
    ('Heavy Haul', 'Lift a total volume of 5,000kg in a single session.', 'daily', 'volume_session', 5000, 200),
    ('Cardio Recon', 'Complete 3km of running or cardio.', 'daily', 'distance', 3000, 150),
    ('Iron Marathon', 'Accumulate 50,000kg of volume this week.', 'weekly', 'volume_weekly', 50000, 1000),
    ('Full Deployment', 'Complete 4 workout sessions this week.', 'weekly', 'workouts_weekly', 4, 800)
ON CONFLICT DO NOTHING; -- Avoid duplicates if re-run

-- Seed Achievements
INSERT INTO public.achievements (name, description, criteria, xp_reward, icon_key, is_hidden)
VALUES
    ('Bootcamp Cleared', 'Complete your very first workout session.', '{"type": "total_workouts", "value": 1}', 100, 'bootcamp_cleared', FALSE),
    ('Dawn Patrol', 'Complete a workout between 0400 and 0600.', '{"type": "activity_time", "start": "04:00", "end": "06:00"}', 200, 'dawn_patrol', FALSE),
    ('Night Ops', 'Complete a workout after 2200 hours.', '{"type": "activity_time", "start": "22:00", "end": "04:00"}', 200, 'night_ops', FALSE),
    ('Squad Leader', 'Connect with 5 friends on IronCircle.', '{"type": "friends_count", "value": 5}', 300, 'squad_leader', FALSE),
    ('Officer Material', 'Reach Level 10.', '{"type": "level", "value": 10}', 500, 'officer_material', FALSE),
    ('Iron Titan', 'Lift a total of 1,000,000kg lifetime volume.', '{"type": "lifetime_volume", "value": 1000000}', 1000, 'iron_titan', FALSE),
    ('Jack of All Trades', 'Complete a Strength, Cardio, and Hybrid workout.', '{"type": "diversity", "value": ["strength", "cardio", "hybrid"]}', 400, 'jack_of_all_trades', TRUE)
ON CONFLICT DO NOTHING;
